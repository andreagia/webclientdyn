<!DOCTYPE html>
<html lang="en">
<head>
    <title>NGL - parallel</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>
<body>
<script>



    //Guardare qui https://jsfiddle.net/potatosalad/FbaM6/


    var outputblob;
    var blob, stage;
    function load( o ){
        stage.loadFile( blob, { ext: "pdb", defaultRepresentation: true } );
    }
    var url = "https://files.rcsb.org/download/1AQA.pdb";
    var xhr = new XMLHttpRequest();
    xhr.open( "GET", url, true );
    xhr.addEventListener( 'load', function( event ){
        blob = new Blob( [ xhr.response ], { type: 'text/html'} );

        if( stage ){
            console.log('sono qui');

            var blobtest = {
                data: null
            };

            blobtest.blob2string = function(blob) {

                var fileReader = new FileReader();
                fileReader.onload = function(event) {
                    var buffer = event.target.result;
                    var chars  = new Uint16Array(buffer);
                    this.data   = String.fromCharCode.apply(null, chars);
                };
                console.log(blob);
                fileReader.readAsArrayBuffer(blob);

                return true;
            };

            blobtest.blob2string(blob);
            console.log(blobtest.data);


            var arrayBuffer;
            var fileReader = new FileReader();
            fileReader.onload = function() {
                arrayBuffer = this.result;
            };
            fileReader.readAsArrayBuffer(blob);
            console.log(fileReader.result);


            var reader = new FileReader();
            reader.onload = function() {
                outputblob=reader.result;
                console.log(outputblob);
                alert(reader.result);

            };

            reader.readAsText(blob);
            console.log(outputblob);
            var base64Image = new Buffer( blob, 'text' ).toString();
            console.log("nuovo");
            console.log(base64Image);

            load();
        }
    } );
    xhr.responseType = "arraybuffer";
    xhr.send( null );

</script>
<script src="js/ngl/ngl.js"></script>
<script>
    document.addEventListener( "DOMContentLoaded", function(){
        stage = new NGL.Stage( "viewport" );
        // if( blob ) {
        //     console.log('sono qui');
        //     load();
        //     var out =blobToString(blob);
        //     console.log(out);
        //}

    } );
</script>
<div id="viewport" style="width:800px; height:800px;"></div>
</body>
</html>